apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: {{ .Values.global.serviceName }}
spec:
  exportTo:
    - "*"
  hosts:
    - {{ .Values.global.serviceName }}
  http:
    - match:
        - port: 9080
      route:
        - destination:
            host: {{ .Values.global.serviceName }}
            port:
              number: 9080
            subset: v1
          weight: 0
        - destination:
            host: {{ .Values.global.serviceName }}
            port:
              number: 9080
            subset: v2
          weight: 100
---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: {{ .Values.global.serviceName }}-egress
spec:
  exportTo:
    - "*"
  hosts:
    - mysqldb
  gateways:
    - mesh
    - {{ .Values.global.serviceName }}-egress
  tcp:
    - match:
        - gateways:
            - mesh
          port: 3306
      route:
        - destination:
            host: istio-egressgateway.istio-egress.svc.cluster.local
            port:
              number: 3306
    - match:
        - gateways:
            - {{ .Values.global.serviceName }}-egress
          port: 3306
      route:
        - destination:
            host: mysqldb.local
            port:
              number: 3306
---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: {{ .Values.global.serviceName }}-curl-egress
spec:
  exportTo:
    - "*"
  hosts:
    - httpbin.org
  gateways:
    - mesh
    - {{ .Values.global.serviceName }}-curl-egress
  http:
    - match:
        - gateways:
            - mesh
          port: 80
      route:
        - destination:
            host: istio-egressgateway.istio-egress.svc.cluster.local
            port:
              number: 80
    - match:
        - gateways:
            - {{ .Values.global.serviceName }}-curl-egress
          port: 80
      route:
        - destination:
            host: httpbin.org
            port:
              number: 80
